var M=Object.defineProperty;var O=(o,t)=>M(o,"name",{value:t,configurable:!0});import{M as P}from"./index-4af01cdc.js";import"./_commonjsHelpers-f86d8be3.js";const{addons:Y}=__STORYBOOK_MODULE_PREVIEW_API__,{once:x,logger:K}=__STORYBOOK_MODULE_CLIENT_LOGGER__,{FORCE_REMOUNT:I,STORY_RENDER_PHASE_CHANGED:G,SET_CURRENT_STORY:$,IGNORED_EXCEPTION:V}=__STORYBOOK_MODULE_CORE_EVENTS__,{global:g}=__STORYBOOK_MODULE_GLOBAL__;var k=(o=>(o.DONE="done",o.ERROR="error",o.ACTIVE="active",o.WAITING="waiting",o))(k||{}),E={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},N={start:!1,back:!1,goto:!1,next:!1,end:!1},A=new Error("This function ran after the play function completed. Did you forget to `await` it?"),C=O(o=>Object.prototype.toString.call(o)==="[object Object]","isObject"),F=O(o=>Object.prototype.toString.call(o)==="[object Module]","isModule"),H=O(o=>{if(!C(o)&&!F(o))return!1;if(o.constructor===void 0)return!0;let t=o.constructor.prototype;return!(!C(t)||Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")===!1)},"isInstrumentable"),z=O(o=>{try{return new o.constructor}catch{return{}}},"construct"),T=O(()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),"getInitialState"),D=O((o,t=!1)=>{let e=(t?o.shadowCalls:o.calls).filter(c=>c.retain);if(!e.length)return;let l=new Map(Array.from(o.callRefsByResult.entries()).filter(([,c])=>c.retain));return{cursor:e.length,calls:e,callRefsByResult:l}},"getRetainedState"),y,W=(y=class{constructor(){this.initialized=!1,this.channel=Y.getChannel(),this.state=g.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let t=O(({storyId:s,isPlaying:i=!0,isDebugging:n=!1})=>{let a=this.getState(s);this.setState(s,{...T(),...D(a,n),shadowCalls:n?a.shadowCalls:[],chainedCallIds:n?a.chainedCallIds:new Set,playUntil:n?a.playUntil:void 0,isPlaying:i,isDebugging:n}),this.sync(s)},"resetState");this.channel.on(I,t),this.channel.on(G,({storyId:s,newPhase:i})=>{let{isDebugging:n}=this.getState(s);this.setState(s,{renderPhase:i}),i==="preparing"&&n&&t({storyId:s}),i==="playing"&&t({storyId:s,isDebugging:n}),i==="played"&&this.setState(s,{isLocked:!1,isPlaying:!1,isDebugging:!1}),i==="errored"&&this.setState(s,{isLocked:!1,isPlaying:!1})}),this.channel.on($,()=>{this.initialized?this.cleanup():this.initialized=!0});let e=O(({storyId:s,playUntil:i})=>{this.getState(s).isDebugging||this.setState(s,({calls:a})=>({calls:[],shadowCalls:a.map(_=>({..._,status:"waiting"})),isDebugging:!0}));let n=this.getLog(s);this.setState(s,({shadowCalls:a})=>{var u;if(i||!n.length)return{playUntil:i};let _=a.findIndex(d=>d.id===n[0].callId);return{playUntil:(u=a.slice(0,_).filter(d=>d.interceptable&&!d.ancestors.length).slice(-1)[0])==null?void 0:u.id}}),this.channel.emit(I,{storyId:s,isDebugging:!0})},"start"),l=O(({storyId:s})=>{var a;let i=this.getLog(s).filter(_=>!_.ancestors.length),n=i.reduceRight((_,u,d)=>_>=0||u.status==="waiting"?_:d,-1);e({storyId:s,playUntil:(a=i[n-1])==null?void 0:a.callId})},"back"),c=O(({storyId:s,callId:i})=>{var f;let{calls:n,shadowCalls:a,resolvers:_}=this.getState(s),u=n.find(({id:p})=>p===i),d=a.find(({id:p})=>p===i);if(!u&&d&&Object.values(_).length>0){let p=(f=this.getLog(s).find(S=>S.status==="waiting"))==null?void 0:f.callId;d.id!==p&&this.setState(s,{playUntil:d.id}),Object.values(_).forEach(S=>S())}else e({storyId:s,playUntil:i})},"goto"),r=O(({storyId:s})=>{var n;let{resolvers:i}=this.getState(s);if(Object.values(i).length>0)Object.values(i).forEach(a=>a());else{let a=(n=this.getLog(s).find(_=>_.status==="waiting"))==null?void 0:n.callId;a?e({storyId:s,playUntil:a}):h({storyId:s})}},"next"),h=O(({storyId:s})=>{this.setState(s,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(s).resolvers).forEach(i=>i())},"end");this.channel.on(E.START,e),this.channel.on(E.BACK,l),this.channel.on(E.GOTO,c),this.channel.on(E.NEXT,r),this.channel.on(E.END,h)}getState(t){return this.state[t]||T()}setState(t,e){let l=this.getState(t),c=typeof e=="function"?e(l):e;this.state={...this.state,[t]:{...l,...c}},g.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((e,[l,c])=>{let r=D(c);return r&&(e[l]=Object.assign(T(),r)),e},{});let t={controlStates:N,logItems:[]};this.channel.emit(E.SYNC,t),g.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(t){let{calls:e,shadowCalls:l}=this.getState(t),c=[...l];e.forEach((h,s)=>{c[s]=h});let r=new Set;return c.reduceRight((h,s)=>(s.args.forEach(i=>{i!=null&&i.__callId__&&r.add(i.__callId__)}),s.path.forEach(i=>{i.__callId__&&r.add(i.__callId__)}),(s.interceptable||s.exception)&&!r.has(s.id)&&(h.unshift({callId:s.id,status:s.status,ancestors:s.ancestors}),r.add(s.id)),h),[])}instrument(t,e){if(!H(t))return t;let{mutate:l=!1,path:c=[]}=e;return Object.keys(t).reduce((r,h)=>{let s=t[h];return typeof s!="function"?(r[h]=this.instrument(s,{...e,path:c.concat(h)}),r):typeof s.__originalFn__=="function"?(r[h]=s,r):(r[h]=(...i)=>this.track(h,s,i,e),r[h].__originalFn__=s,Object.defineProperty(r[h],"name",{value:h,writable:!1}),Object.keys(s).length>0&&Object.assign(r[h],this.instrument({...s},{...e,path:c.concat(h)})),r)},l?t:z(t))}track(t,e,l,c){var p,S,R,w;let r=((p=l==null?void 0:l[0])==null?void 0:p.__storyId__)||((w=(R=(S=g.__STORYBOOK_PREVIEW__)==null?void 0:S.selectionStore)==null?void 0:R.selection)==null?void 0:w.storyId),{cursor:h,ancestors:s}=this.getState(r);this.setState(r,{cursor:h+1});let i=`${s.slice(-1)[0]||r} [${h}] ${t}`,{path:n=[],intercept:a=!1,retain:_=!1}=c,u=typeof a=="function"?a(t,n):a,d={id:i,cursor:h,storyId:r,ancestors:s,path:n,method:t,args:l,interceptable:u,retain:_},f=(u&&!s.length?this.intercept:this.invoke).call(this,e,d,c);return this.instrument(f,{...c,mutate:!0,path:[{__callId__:d.id}]})}intercept(t,e,l){let{chainedCallIds:c,isDebugging:r,playUntil:h}=this.getState(e.storyId),s=c.has(e.id);return!r||s||h?(h===e.id&&this.setState(e.storyId,{playUntil:void 0}),this.invoke(t,e,l)):new Promise(i=>{this.setState(e.storyId,({resolvers:n})=>({isLocked:!1,resolvers:{...n,[e.id]:i}}))}).then(()=>(this.setState(e.storyId,i=>{let{[e.id]:n,...a}=i.resolvers;return{isLocked:!0,resolvers:a}}),this.invoke(t,e,l)))}invoke(t,e,l){let{callRefsByResult:c,renderPhase:r}=this.getState(e.storyId),h=O(n=>{var a,_;if(c.has(n))return c.get(n);if(n instanceof Array)return n.map(h);if(n instanceof Date)return{__date__:{value:n.toISOString()}};if(n instanceof Error){let{name:u,message:d,stack:f}=n;return{__error__:{name:u,message:d,stack:f}}}if(n instanceof RegExp){let{flags:u,source:d}=n;return{__regexp__:{flags:u,source:d}}}if(n instanceof g.window.HTMLElement){let{prefix:u,localName:d,id:f,classList:p,innerText:S}=n,R=Array.from(p);return{__element__:{prefix:u,localName:d,id:f,classNames:R,innerText:S}}}return typeof n=="function"?{__function__:{name:n.name}}:typeof n=="symbol"?{__symbol__:{description:n.description}}:typeof n=="object"&&((a=n==null?void 0:n.constructor)!=null&&a.name)&&((_=n==null?void 0:n.constructor)==null?void 0:_.name)!=="Object"?{__class__:{name:n.constructor.name}}:Object.prototype.toString.call(n)==="[object Object]"?Object.fromEntries(Object.entries(n).map(([u,d])=>[u,h(d)])):n},"serializeValues"),s={...e,args:e.args.map(h)};e.path.forEach(n=>{n!=null&&n.__callId__&&this.setState(e.storyId,({chainedCallIds:a})=>({chainedCallIds:new Set(Array.from(a).concat(n.__callId__))}))});let i=O(n=>{if(n instanceof Error){let{name:a,message:_,stack:u,callId:d=e.id}=n,f={name:a,message:_,stack:u,callId:d};if(this.update({...s,status:"error",exception:f}),this.setState(e.storyId,p=>({callRefsByResult:new Map([...Array.from(p.callRefsByResult.entries()),[n,{__callId__:e.id,retain:e.retain}]])})),e.ancestors.length)throw Object.prototype.hasOwnProperty.call(n,"callId")||Object.defineProperty(n,"callId",{value:e.id}),n;if(n!==A)throw K.warn(n),V}throw n},"handleException");try{if(r==="played"&&!e.retain)throw A;let n=(l.getArgs?l.getArgs(e,this.getState(e.storyId)):e.args).map(_=>typeof _!="function"||Object.keys(_).length?_:(...u)=>{let{cursor:d,ancestors:f}=this.getState(e.storyId);this.setState(e.storyId,{cursor:0,ancestors:[...f,e.id]});let p=O(()=>this.setState(e.storyId,{cursor:d,ancestors:f}),"restore"),S=!1;try{let R=_(...u);return R instanceof Promise?(S=!0,R.finally(p)):R}finally{S||p()}}),a=t(...n);return a&&["object","function","symbol"].includes(typeof a)&&this.setState(e.storyId,_=>({callRefsByResult:new Map([...Array.from(_.callRefsByResult.entries()),[a,{__callId__:e.id,retain:e.retain}]])})),this.update({...s,status:a instanceof Promise?"active":"done"}),a instanceof Promise?a.then(_=>(this.update({...s,status:"done"}),_),i):a}catch(n){return i(n)}}update(t){this.channel.emit(E.CALL,t),this.setState(t.storyId,({calls:e})=>{let l=e.concat(t).reduce((c,r)=>Object.assign(c,{[r.id]:r}),{});return{calls:Object.values(l).sort((c,r)=>c.id.localeCompare(r.id,void 0,{numeric:!0}))}}),this.sync(t.storyId)}sync(t){let e=O(()=>{var a;let{isLocked:l,isPlaying:c}=this.getState(t),r=this.getLog(t),h=(a=r.filter(({ancestors:_})=>!_.length).find(_=>_.status==="waiting"))==null?void 0:a.callId,s=r.some(_=>_.status==="active");if(l||s||r.length===0){let _={controlStates:N,logItems:r};this.channel.emit(E.SYNC,_);return}let i=r.some(_=>_.status==="done"||_.status==="error"),n={controlStates:{start:i,back:i,goto:!0,next:c,end:c},logItems:r,pausedAt:h};this.channel.emit(E.SYNC,n)},"synchronize");this.setState(t,({syncTimeout:l})=>(clearTimeout(l),{syncTimeout:setTimeout(e,0)}))}},O(y,"Instrumenter"),y);function U(o,t={}){var e,l,c,r;try{let h=!1,s=!1;return(l=(e=g.window.location)==null?void 0:e.search)!=null&&l.includes("instrument=true")?h=!0:(r=(c=g.window.location)==null?void 0:c.search)!=null&&r.includes("instrument=false")&&(s=!0),g.window.parent===g.window&&!h||s?o:(g.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(g.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new W),g.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(o,t))}catch(h){return x.warn(h),o}}O(U,"instrument");const{addons:X}=__STORYBOOK_MODULE_PREVIEW_API__,{global:J}=__STORYBOOK_MODULE_GLOBAL__,{FORCE_REMOUNT:q,STORY_RENDER_PHASE_CHANGED:Q}=__STORYBOOK_MODULE_CORE_EVENTS__;var L=new P(J),Z=L.fn.bind(L),{action:v}=U({action:Z},{retain:!0}),B=X.getChannel(),j=new Set,b=[];B.on(q,()=>b.forEach(o=>{var t;return(t=o==null?void 0:o.mockClear)==null?void 0:t.call(o)}));B.on(Q,({newPhase:o})=>{o==="loading"&&b.forEach(t=>{var e;return(e=t==null?void 0:t.mockClear)==null?void 0:e.call(t)})});var m=O((o,t,e)=>{if(j.has(t))return t;j.add(t);try{if(Object.prototype.toString.call(t)==="[object Object]"){for(let[l,c]of Object.entries(t))t[l]=m(o,c,l);return t}if(Array.isArray(t))return t.map((l,c)=>m(o,l,`${e}[${c}]`));if(typeof t=="function"&&t.isAction){Object.defineProperty(t,"name",{value:e,writable:!1}),Object.defineProperty(t,"__storyId__",{value:o,writable:!1});let l=v(t);return b.push(l),l}}catch{}return t},"addSpies"),tt=O(({id:o,initialArgs:t})=>m(o,t),"addActionsFromArgTypes"),it=[tt],{step:rt}=U({step:(o,t,e)=>t(e)},{intercept:!0}),at={throwPlayFunctionExceptions:!1};export{it as argsEnhancers,at as parameters,rt as runStep};
//# sourceMappingURL=preview-0813f14d.js.map
