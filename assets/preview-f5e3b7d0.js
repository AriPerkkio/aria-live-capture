var L=Object.defineProperty;var u=(e,t)=>L(e,"name",{value:t,configurable:!0});import{s as f}from"./index-722d4584.js";import{M}from"./index-c8c96787.js";const{addons:P}=__STORYBOOK_MODULE_PREVIEW_API__,{once:B,logger:Y}=__STORYBOOK_MODULE_CLIENT_LOGGER__,{FORCE_REMOUNT:w,STORY_RENDER_PHASE_CHANGED:x,SET_CURRENT_STORY:K,IGNORED_EXCEPTION:G}=__STORYBOOK_MODULE_CORE_EVENTS__;var V=(e=>(e.DONE="done",e.ERROR="error",e.ACTIVE="active",e.WAITING="waiting",e))(V||{}),S={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},I={start:!1,back:!1,goto:!1,next:!1,end:!1},b=new Error("This function ran after the play function completed. Did you forget to `await` it?"),N=u(e=>Object.prototype.toString.call(e)==="[object Object]","isObject"),$=u(e=>Object.prototype.toString.call(e)==="[object Module]","isModule"),k=u(e=>{if(!N(e)&&!$(e))return!1;if(e.constructor===void 0)return!0;let t=e.constructor.prototype;return!(!N(t)||Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")===!1)},"isInstrumentable"),F=u(e=>{try{return new e.constructor}catch{return{}}},"construct"),R=u(()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),"getInitialState"),A=u((e,t=!1)=>{let o=(t?e.shadowCalls:e.calls).filter(i=>i.retain);if(!o.length)return;let c=new Map(Array.from(e.callRefsByResult.entries()).filter(([,i])=>i.retain));return{cursor:o.length,calls:o,callRefsByResult:c}},"getRetainedState"),H=u(class{constructor(){this.initialized=!1,this.channel=P.getChannel(),this.state=f.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let e=u(({storyId:s,isPlaying:r=!0,isDebugging:n=!1})=>{let a=this.getState(s);this.setState(s,{...R(),...A(a,n),shadowCalls:n?a.shadowCalls:[],chainedCallIds:n?a.chainedCallIds:new Set,playUntil:n?a.playUntil:void 0,isPlaying:r,isDebugging:n}),this.sync(s)},"resetState");this.channel.on(w,e),this.channel.on(x,({storyId:s,newPhase:r})=>{let{isDebugging:n}=this.getState(s);this.setState(s,{renderPhase:r}),r==="preparing"&&n&&e({storyId:s}),r==="playing"&&e({storyId:s,isDebugging:n}),r==="played"&&this.setState(s,{isLocked:!1,isPlaying:!1,isDebugging:!1}),r==="errored"&&this.setState(s,{isLocked:!1,isPlaying:!1})}),this.channel.on(K,()=>{this.initialized?this.cleanup():this.initialized=!0});let t=u(({storyId:s,playUntil:r})=>{this.getState(s).isDebugging||this.setState(s,({calls:a})=>({calls:[],shadowCalls:a.map(l=>({...l,status:"waiting"})),isDebugging:!0}));let n=this.getLog(s);this.setState(s,({shadowCalls:a})=>{var d;if(r||!n.length)return{playUntil:r};let l=a.findIndex(h=>h.id===n[0].callId);return{playUntil:(d=a.slice(0,l).filter(h=>h.interceptable&&!h.ancestors.length).slice(-1)[0])==null?void 0:d.id}}),this.channel.emit(w,{storyId:s,isDebugging:!0})},"start"),o=u(({storyId:s})=>{var a;let r=this.getLog(s).filter(l=>!l.ancestors.length),n=r.reduceRight((l,d,h)=>l>=0||d.status==="waiting"?l:h,-1);t({storyId:s,playUntil:(a=r[n-1])==null?void 0:a.callId})},"back"),c=u(({storyId:s,callId:r})=>{var p;let{calls:n,shadowCalls:a,resolvers:l}=this.getState(s),d=n.find(({id:O})=>O===r),h=a.find(({id:O})=>O===r);if(!d&&h&&Object.values(l).length>0){let O=(p=this.getLog(s).find(g=>g.status==="waiting"))==null?void 0:p.callId;h.id!==O&&this.setState(s,{playUntil:h.id}),Object.values(l).forEach(g=>g())}else t({storyId:s,playUntil:r})},"goto"),i=u(({storyId:s})=>{var n;let{resolvers:r}=this.getState(s);if(Object.values(r).length>0)Object.values(r).forEach(a=>a());else{let a=(n=this.getLog(s).find(l=>l.status==="waiting"))==null?void 0:n.callId;a?t({storyId:s,playUntil:a}):_({storyId:s})}},"next"),_=u(({storyId:s})=>{this.setState(s,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(s).resolvers).forEach(r=>r())},"end");this.channel.on(S.START,t),this.channel.on(S.BACK,o),this.channel.on(S.GOTO,c),this.channel.on(S.NEXT,i),this.channel.on(S.END,_)}getState(e){return this.state[e]||R()}setState(e,t){let o=this.getState(e),c=typeof t=="function"?t(o):t;this.state={...this.state,[e]:{...o,...c}},f.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((t,[o,c])=>{let i=A(c);return i&&(t[o]=Object.assign(R(),i)),t},{});let e={controlStates:I,logItems:[]};this.channel.emit(S.SYNC,e),f.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(e){let{calls:t,shadowCalls:o}=this.getState(e),c=[...o];t.forEach((_,s)=>{c[s]=_});let i=new Set;return c.reduceRight((_,s)=>(s.args.forEach(r=>{r!=null&&r.__callId__&&i.add(r.__callId__)}),s.path.forEach(r=>{r.__callId__&&i.add(r.__callId__)}),(s.interceptable||s.exception)&&!i.has(s.id)&&(_.unshift({callId:s.id,status:s.status,ancestors:s.ancestors}),i.add(s.id)),_),[])}instrument(e,t){if(!k(e))return e;let{mutate:o=!1,path:c=[]}=t;return Object.keys(e).reduce((i,_)=>{let s=e[_];return typeof s!="function"?(i[_]=this.instrument(s,{...t,path:c.concat(_)}),i):typeof s.__originalFn__=="function"?(i[_]=s,i):(i[_]=(...r)=>this.track(_,s,r,t),i[_].__originalFn__=s,Object.defineProperty(i[_],"name",{value:_,writable:!1}),Object.keys(s).length>0&&Object.assign(i[_],this.instrument({...s},{...t,path:c.concat(_)})),i)},o?e:F(e))}track(e,t,o,c){var O,g,E,m;let i=((O=o==null?void 0:o[0])==null?void 0:O.__storyId__)||((m=(E=(g=f.__STORYBOOK_PREVIEW__)==null?void 0:g.selectionStore)==null?void 0:E.selection)==null?void 0:m.storyId),{cursor:_,ancestors:s}=this.getState(i);this.setState(i,{cursor:_+1});let r=`${s.slice(-1)[0]||i} [${_}] ${e}`,{path:n=[],intercept:a=!1,retain:l=!1}=c,d=typeof a=="function"?a(e,n):a,h={id:r,cursor:_,storyId:i,ancestors:s,path:n,method:e,args:o,interceptable:d,retain:l},p=(d&&!s.length?this.intercept:this.invoke).call(this,t,h,c);return this.instrument(p,{...c,mutate:!0,path:[{__callId__:h.id}]})}intercept(e,t,o){let{chainedCallIds:c,isDebugging:i,playUntil:_}=this.getState(t.storyId),s=c.has(t.id);return!i||s||_?(_===t.id&&this.setState(t.storyId,{playUntil:void 0}),this.invoke(e,t,o)):new Promise(r=>{this.setState(t.storyId,({resolvers:n})=>({isLocked:!1,resolvers:{...n,[t.id]:r}}))}).then(()=>(this.setState(t.storyId,r=>{let{[t.id]:n,...a}=r.resolvers;return{isLocked:!0,resolvers:a}}),this.invoke(e,t,o)))}invoke(e,t,o){let{callRefsByResult:c,renderPhase:i}=this.getState(t.storyId),_=u(n=>{var a,l;if(c.has(n))return c.get(n);if(n instanceof Array)return n.map(_);if(n instanceof Date)return{__date__:{value:n.toISOString()}};if(n instanceof Error){let{name:d,message:h,stack:p}=n;return{__error__:{name:d,message:h,stack:p}}}if(n instanceof RegExp){let{flags:d,source:h}=n;return{__regexp__:{flags:d,source:h}}}if(n instanceof f.window.HTMLElement){let{prefix:d,localName:h,id:p,classList:O,innerText:g}=n,E=Array.from(O);return{__element__:{prefix:d,localName:h,id:p,classNames:E,innerText:g}}}return typeof n=="function"?{__function__:{name:n.name}}:typeof n=="symbol"?{__symbol__:{description:n.description}}:typeof n=="object"&&((a=n==null?void 0:n.constructor)!=null&&a.name)&&((l=n==null?void 0:n.constructor)==null?void 0:l.name)!=="Object"?{__class__:{name:n.constructor.name}}:Object.prototype.toString.call(n)==="[object Object]"?Object.fromEntries(Object.entries(n).map(([d,h])=>[d,_(h)])):n},"serializeValues"),s={...t,args:t.args.map(_)};t.path.forEach(n=>{n!=null&&n.__callId__&&this.setState(t.storyId,({chainedCallIds:a})=>({chainedCallIds:new Set(Array.from(a).concat(n.__callId__))}))});let r=u(n=>{if(n instanceof Error){let{name:a,message:l,stack:d,callId:h=t.id}=n,p={name:a,message:l,stack:d,callId:h};if(this.update({...s,status:"error",exception:p}),this.setState(t.storyId,O=>({callRefsByResult:new Map([...Array.from(O.callRefsByResult.entries()),[n,{__callId__:t.id,retain:t.retain}]])})),t.ancestors.length)throw Object.prototype.hasOwnProperty.call(n,"callId")||Object.defineProperty(n,"callId",{value:t.id}),n;if(n!==b)throw Y.warn(n),G}throw n},"handleException");try{if(i==="played"&&!t.retain)throw b;let n=(o.getArgs?o.getArgs(t,this.getState(t.storyId)):t.args).map(l=>typeof l!="function"||Object.keys(l).length?l:(...d)=>{let{cursor:h,ancestors:p}=this.getState(t.storyId);this.setState(t.storyId,{cursor:0,ancestors:[...p,t.id]});let O=u(()=>this.setState(t.storyId,{cursor:h,ancestors:p}),"restore"),g=!1;try{let E=l(...d);return E instanceof Promise?(g=!0,E.finally(O)):E}finally{g||O()}}),a=e(...n);return a&&["object","function","symbol"].includes(typeof a)&&this.setState(t.storyId,l=>({callRefsByResult:new Map([...Array.from(l.callRefsByResult.entries()),[a,{__callId__:t.id,retain:t.retain}]])})),this.update({...s,status:a instanceof Promise?"active":"done"}),a instanceof Promise?a.then(l=>(this.update({...s,status:"done"}),l),r):a}catch(n){return r(n)}}update(e){this.channel.emit(S.CALL,e),this.setState(e.storyId,({calls:t})=>{let o=t.concat(e).reduce((c,i)=>Object.assign(c,{[i.id]:i}),{});return{calls:Object.values(o).sort((c,i)=>c.id.localeCompare(i.id,void 0,{numeric:!0}))}}),this.sync(e.storyId)}sync(e){let t=u(()=>{var a;let{isLocked:o,isPlaying:c}=this.getState(e),i=this.getLog(e),_=(a=i.filter(({ancestors:l})=>!l.length).find(l=>l.status==="waiting"))==null?void 0:a.callId,s=i.some(l=>l.status==="active");if(o||s||i.length===0){let l={controlStates:I,logItems:i};this.channel.emit(S.SYNC,l);return}let r=i.some(l=>["done","error"].includes(l.status)),n={controlStates:{start:r,back:r,goto:!0,next:c,end:c},logItems:i,pausedAt:_};this.channel.emit(S.SYNC,n)},"synchronize");this.setState(e,({syncTimeout:o})=>(clearTimeout(o),{syncTimeout:setTimeout(t,0)}))}},"Instrumenter");function j(e,t={}){var o,c,i,_;try{let s=!1,r=!1;return(c=(o=f.window.location)==null?void 0:o.search)!=null&&c.includes("instrument=true")?s=!0:(_=(i=f.window.location)==null?void 0:i.search)!=null&&_.includes("instrument=false")&&(r=!0),f.window.parent===f.window&&!s||r?e:(f.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(f.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new H),f.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(e,t))}catch(s){return B.warn(s),e}}u(j,"instrument");const{addons:z}=__STORYBOOK_MODULE_PREVIEW_API__,{FORCE_REMOUNT:W,STORY_RENDER_PHASE_CHANGED:X}=__STORYBOOK_MODULE_CORE_EVENTS__;var C=new M(f),J=C.fn.bind(C),{action:q}=j({action:J},{retain:!0}),U=z.getChannel(),D=new Set,T=[];U.on(W,()=>T.forEach(e=>{var t;return(t=e==null?void 0:e.mockClear)==null?void 0:t.call(e)}));U.on(X,({newPhase:e})=>{e==="loading"&&T.forEach(t=>{var o;return(o=t==null?void 0:t.mockClear)==null?void 0:o.call(t)})});var y=u((e,t,o)=>{if(D.has(t))return t;D.add(t);try{if(Object.prototype.toString.call(t)==="[object Object]"){for(let[c,i]of Object.entries(t))t[c]=y(e,i,c);return t}if(Array.isArray(t))return t.map((c,i)=>y(e,c,`${o}[${i}]`));if(typeof t=="function"&&t.isAction){Object.defineProperty(t,"name",{value:o,writable:!1}),Object.defineProperty(t,"__storyId__",{value:e,writable:!1});let c=q(t);return T.push(c),c}}catch{}return t},"addSpies"),Q=u(({id:e,initialArgs:t})=>y(e,t),"addActionsFromArgTypes"),et=[Q],{step:nt}=j({step:(e,t,o)=>t(o)},{intercept:!0}),st={throwPlayFunctionExceptions:!1};export{et as argsEnhancers,st as parameters,nt as runStep};
//# sourceMappingURL=preview-f5e3b7d0.js.map
